<!DOCTYPE HTML>
<html>
<head>
	
	<link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen" />

	<script src="http://code.jquery.com/jquery-latest.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js"></script>
	<script type="text/javascript" src="http://staging.html5video.org/testswarm/js/inject.js"></script>
	<!--[if IE]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

<script>

var $$ = jQuery.noConflict(true);
var $ = jQuery = null; // will always run the tested page's jquery from $
var mw = null; // we will be grabbing the mw from the iframe

var testLocation = "../../modules/EmbedPlayer/tests/Player_Sources.html";

QUnit.config.autostart = false;

function runTests() {
	
	module("Embed Player Loads");

	test("embed player is embedded", function() {
		ok( $('.mv-player', '.mwplayer_interface' ) );
	});

	test("embed player is skinned", function() {
		ok( $('.play-btn-large') );
	});
	
	module("Embed Player Plays",
	{
		setup: function() 
		{
			this.player = $('#vid1').get(0);
			this.player.play();
			this.passed = false;
		},
		teardown: function()
		{
			if ( this.player.isPlaying ) 
			{ 
				this.player.stop(); 
			}
			this.player = undefined;
			this.passed = undefined;
		}
	});

	asyncTest("playback begins", function() {
		var player = this.player;
		setTimeout( function()
		{
			equal( player.isPlaying(), true );
			start();
		}, 2000);
	});
		
	asyncTest("playhead progresses", function() {
		var player = this.player;
		var passed = this.passed;
		setTimeout( function()
		{
			if ( player.currentTime > 0 ) { passed = true; };
			console.log("current time: " + player.currentTime + " is greater than 0: " + passed)
			ok( passed );
			start();
		}, 3000);
	});

	asyncTest("pause playback", function() {
		var player = this.player;
		setTimeout( function() 
		{
			player.pause();
			equal( player.isPlaying(), false );
			start();
		}, 2000);
	});

	asyncTest("resume playback", function() {
		var player = this.player;
		player.pause();
		setTimeout( function()
		{ 
			player.play();
			equal( player.isPlaying(), true );
			start();
		}, 1000);

	});

	asyncTest("seek to video beginning + 5 sec", function() {
		var player = this.player;
		var passed = this.passed;
		setTimeout( function()
		{ 
			player.doSeek( 5 / player.duration );
			var time = player.currentTime;
			if ( player.currentTime <= 7 & player.currentTime >= 5) 
			{ 
				passed = true;
			} else {
				passed = false;
			}
			equal( passed, true );
			start();
		}, 2000);
	});

	asyncTest("playback ends", function() {
		var player = this.player;
		var passed = this.passed;
		$(player).bind('ended', function() { passed = true } );
		player.doSeek( (player.duration - 2) / player.duration );
		setTimeout( function()
		{
			equal( passed, true );
			start();
		}, 3000);
	});
};


$$(document).ready(function(){
	$$(document.body).prepend('<iframe name="testFrame" id="testFrame" src="'+testLocation+'" width="100%" height="300px" border="none">');
	//autoResize('testFrame');
	
	$$('#testFrame').load(function () {
		setTimeout( function(){
			mw = window.frames["testFrame"].mw;
			mw.ready(function(){
				//grab jQuery from inside the document
				$ = jQuery = window.frames["testFrame"].$j;
				QUnit.start();
				runTests();
			});
		}, 5000);
	});
});

</script>
</head>
<body>
	<h1 id="qunit-header">QUnit example</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>
