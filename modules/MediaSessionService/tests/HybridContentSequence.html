<!DOCTYPE HTML>
<html>
<head>
<title> Content sequence </title>
<script type="text/javascript" src="../../../tests/qunit/qunit-bootstrap.js"></script>
<script type="text/javascript" src="../../../mwEmbedLoader.php"></script>
<script type="text/javascript" src="../../../docs/js/doc-bootstrap.js"></script>
<!-- qunit-kaltura must come after qunit-bootstrap.js and after mwEmbedLoader.php and after any jsCallbackReady stuff-->
<script type="text/javascript" src="../../KalturaSupport/tests/resources/qunit-kaltura-bootstrap.js"></script>
</head>
<body>
<h2>  Content sequence</h2>
<div id="kaltura-player" style="width:430px;height:330px;float:left"></div>

<div id="medialog-container" style="overflow:hidden;padding-left:10px;"> 
<h3 style="margin-top:-10px;"> Server Side Media State Events</h3>
<textarea id="medialog" style="width:96%;height:280px;"></textarea>
</div>

<h3> </h3>
<script>
	// clear the companions 
	$('#testLongCompanion').text('( long companion target )');
	$('#testCompanion').text( '( companion target )' );
	kWidget.featureConfig({
		'cache_st': 101,
		'targetId': 'kaltura-player',
		'wid': '_243342',
		'uiconf_id' : '21099702',
		'entry_id' : '1_c9mv0l7n',
		'flashvars': {
			'mediaSessionService':{
				'plugin': true,
				'socketLog': true,
				'guid': null,
				'playlistId': '0_dk33j8kb'
			}
		}, 
		'readyCallback': function( playerId ){
			var kdp = $('#' + playerId )[0];
			kdp.kBind("layoutReady", function(){
				// check if socket log is enabled and intiate it on-page:
				if( kdp.evaluate('{mediaSessionService.socketLog}') ){
					initiateSocketLog( kdp.evaluate( '{mediaSessionService.guid}' ) );
				}
			});
			
			// check if browser supports HLS: 
			var dummyvid = document.createElement( "video" );
			// check if the browser can even support HLS: 
			if( !dummyvid.canPlayType('application/vnd.apple.mpegurl; codecs="avc1.42E01E"' ) ){	
				$('#kaltura-player').before(
					'<div class="alert alert-warning"><strong>Warning</strong> This demo works best with HLS enabled browser ( Safari or iOS ). <i>Flash based HLS will be supported soon</i>.</div>'
				)
			}
			
			$p = $( '#medialog-container' );
			// remove existing
			$( '#testLongCompanion,#testCompanion').remove();
			// add the companion targets after player ready to place them in the correct location: 
			$p.after('<div style="clear:both"></div>' +
				'<div id="companion-desc"><h3>Companion Ads</h3>Full companion ads support is retained with kaltura\'s hybrid stitching solution:</div><br>' +
				'<div id="testLongCompanion" style="float:left;width:710px;height:90px;;border:solid thin black;padding:5px;margin:5px;"> ( long companion target )</div>' +
				'<div id="testCompanion" style="width:300px;height:250px;float:left;border:solid thin black;padding:5px;margin:5px;"> ( companion target ) </div>'
			);
			
			kdp.kBind('adClick', function(){
				kWidget.log('vast:: adClick event');
			});
		}
	})
</script>

<script> 
	function logMessage(msg){
		$( '#medialog' ).prepend( msg + "\n" );
	}
	function initiateSocketLog( instaceGuid ){
		// register the guid on the page: 
		logMessage( 'Open Connection: ' + instaceGuid );
		// MediaState relay ( not needed for syndication mode)
		var host = window.location.hostname;
		var conn = new WebSocket('ws://' + host + ':8080' + '/mwEmbedSocket');
		
		conn.onopen = function(e) {
			logMessage("Connection established!");
			// send the guid:
			try{
				conn.send(
					JSON.stringify({
						'action': 'subscribe',
						'guid': instaceGuid
					})
				);
			} catch(exception){  
				logMessage('Error:' + exception);
			} 
		};
		conn.onerror = function(e){
			logMessage("Connection failed!");
		}
		conn.onclose = function(e){
			logMessage("Connection closed!");
		}
		conn.onmessage = function(e) {
			var msgData = JSON.parse( e.data );
			// this socket only handles messages ( future socket could handle realtime ads.  )
			if( msgData.action == 'message' ){
				logMessage( msgData.data );
			}
		};
	}
</script>

</body>
</html>
